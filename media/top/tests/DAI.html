<head>
<title>PRISA DAI</title>
</head>

<script>

	//tplib = true;
	mm_base = true;

</script>

<style>
input{
	padding:20px;
}

input[type="button"]{
    padding: 20px;
    background: #db2b36;
    color: white;
    border: 0;
    border-radius: 10px;
    width: 100%;
}

body{
	background:#333;
	color:white;
	font-family:Arial;
}

.oculto{
	display:none;
}

.ocultisimo{
	display:none;
}

td{
	padding:10px;
}

</style>
<script type="text/javascript" src="/psdmedia/media/simple/js/SimpleMediaPlayer.min.js"></script> 
<h3><img src="http://www.prisa.com/packages/ttt/publica/img/logo-home.png"/> DAI</h3>

<div id="container_video_44632" style="width:49%;float:left;"></div>
<div id='timer' style='position:fixed;top:10px;right:10px;background:#111;color:white;font-size:30px;padding:20px;border-radius:10px;'>-</div>
<div id='info' style='width:80%;text-align:center;background:#f3bd58;color:#333;position:absolute;bottom:10px;left:10%;padding:10px;border-radius:10px;opacity:0;transition:opacity 0.5s linear;'></div>
<div style='float:left;width:49%;'>
	<table>
		<tr class='oculto ocultisimo' style='display:none;'>
			<td>
				<input type='button' value='Play ad' onclick='ppp.midroll();'/>
			</td>
			<td></td>
		</tr>
		<tr class='oculto ocultisimo'>
			<td>
		        <input type='button' value='Force ad' onclick='ddd=1'/>
			</td>
			<td></td>
		</tr>
        <tr style='background:#111;'>
            <td colspan=3><b>Option 1:</b> Manually force AD insertion on Live feed</td>
		</tr>
		<tr style='background:#222;'>
            <td colspan=3><span style='color:#888'>Listen events from a server. In the server editor you can remotely force an AD or play/pause player</span></td>
        </tr>
        <tr>
			<td>
				<iframe style='border:none;height:50px;width:100%;' src='http://danielmena.es/pruebas/es2.php?hacer=k'></iframe>
			</td>
            <td colpan='2'>
				<input type='button' value='Open event-sources editor in tab' onclick='window.open("http://danielmena.es/pruebas/es2.php","_blank")'/>
			</td>
        </tr>
        <tr style='background:#111;'>
            <td colspan=3><b>Option 2:</b> Programmed AD insertion out of time sequence</td>
        </tr>
        <tr style='background:#222;'>
            <td colspan=3><span style='color:#888'>Load ADs in sequence. Values in input defines the number of seconds between ADs.<br><br>e.g. 20,40,65 <span style='color:#db2b36'>&rarr;</span>  show ADS in 20 secs, 40 secs and 65 secs</span></td>
        </tr>
        <tr>
            <td>
				<input type='button' value='Start progress' onclick='ini();'/>
			</td>
            <td>
		        Seconds between ADs<br>
        		<input style='padding:5px;' id='segundos' type='text' value='20,40,65'/><br>
			</td>
			<td>                
				<input type='button' value='Stop sequence' onclick='clears();'/>
			</td>
        </tr>
        <tr style='background:#111;'>
            <td colspan=3><b>Option 3:</b> Programmed Ad insertion based on content length</td>
        </tr>
        <tr style='background:#222;'>
            <td colspan=3><span style='color:#888'>Load ADs in loop. Value in input defines the number of seconds between loop.<br><br>e.g. 30  <span style='color:#db2b36'>&rarr; </span> shows ADS after 30 secs, 60 secs, 90 secs...</span></td>
        </tr>
		<tr>
			<td>
                <input type='button' value='Start loop' onclick='ini2();'/>
			</td>
			<td>
                Seconds in loop<br>
	            <input style='padding:5px;' id='segundos2' type='text' value='30'/><br>
			</td>
            <td>
                <input type='button' value='Stop loop' onclick='clears();'/>
            </td>
		</tr>
	</table>
</div>

<script type="text/javascript"> 

    function getget(name,url) {
        if (!url) url = window.location.href;
        //url = url.toLowerCase(); // This is just to avoid case sensitiveness
        name = name.replace(/[\[\]]/g, "\\$&");// This is just to avoid case sensitiveness for query parameter name
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';

        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

var autoplay = true;
if(getget("noautoplay")=="1")
	autoplay = false;

(function() {
	mediaTopEmbed = new psd.media.TopEmbed({ 
		"id_cuenta": "demo", 
		"id_player": "181", 
		"id_media": "20161108140344", 
		"media_type" : "video",
		"id_container": "container_video_44632",
		"topPlayer":{
			"media":{ "autoplay":autoplay}
		}

	}); 
/*conf prueba carlos
    mediaTopEmbed = new psd.media.TopEmbed({
        "id_cuenta": "demo",
        "id_player": "147",
        "dev": true,
        "id_media": "20170127140727",
        "media_type" : "video",
        "id_container": "container_video_44632",
        "topPlayer":{
            "media":{ "autoplay":true}
        }
	});*/


	ddd = 1;
	if(getget("show")=="1"){
		ocultos = document.getElementsByClassName("oculto");
		for(i in ocultos){
			ocultos[i].className = "";
		}
	}

	var init = function(){
		mediaTopEmbed.setRatio(16,9,true);
		ppp = mediaTopEmbed.getMediaPlayer();
		es();
	}; 
	
	mediaTopEmbed.addEventListener(psd.media.TopEmbedEvent.EVENT_INI,init); 
	
})();

midRoll = function(loop,segundos,mediaplayer){

	var _that = this;
	var _secs = 0;
	
	this.mediaPlayer = mediaplayer;
	this.soyloop = loop;

	var times = segundos;

	if(typeof(window._intervalo)!="undefined")
		clearInterval(window._intervalo);

	window._intervalo = null;

	this.check = function(){
		if(this.soyloop){
			if(_secs%times[0]==0){
				console.log("ad in loop");
				showinfo("AD from loop");
				document.getElementById("timer").style.color = "#db2b36";
				this.mediaPlayer.midroll();
			}else{
				document.getElementById("timer").style.color = "white";
			}
		}
		else{
			for(i in times){
				if(times[i]==_secs){
	               document.getElementById("timer").style.color = "#db2b36";
					console.log("AD!!!!");
					this.mediaPlayer.midroll();
					msg = "Ad from sequence";
					if(times[times.length-1]==_secs){
						clearInterval(window._intervalo);
						console.log("no more ADs");
						msg += ". No more ADs";
						document.getElementById("timer").innerHTML = " - ";
		                document.getElementById("timer").style.color = "white";
					}
                    showinfo(msg);
				}else{
                   document.getElementById("timer").style.color = "white";
				}
			}
		}
	}

	if(times.length>0){
		window._intervalo = setInterval(
			function(){
				_secs++;
				console.log(_secs);
				document.getElementById("timer").innerHTML = "Elapsed seconds: " + _secs;
				_that.check(); 
			}, 
			1000);
	}

	this.clear = function(){
		clearInterval(window._intervalo);
	}
};

clears = function(){
	if(typeof(m)!="undefined")
		m.clear();

	showinfo("Interval cleared");

    document.getElementById("timer").innerHTML = " - ";
}

ini = function(){
	//ppp.getMediaModule().play();
	m = new midRoll(false,document.getElementById("segundos").value.split(","),ppp);
	showinfo("Starting sequence");
}

ini2 = function(){
	//ppp.getMediaModule().play();
	m = new midRoll(true,document.getElementById("segundos2").value.split(","),ppp);
	m.soyloop = true;
    showinfo("Starting loop");
}

showinfo = function(msg){
	document.getElementById("info").style.opacity = 1;
	document.getElementById("info").innerHTML = msg;
	setTimeout(function(){document.getElementById("info").style.opacity = 0;},3000);
}

es = function(){

	last = 0;

	showinfo("Connecting to event-sources");

	var source = new EventSource("http://danielmena.es/pruebas/es.php");
		source.onmessage = function(event) {
			if(last==event.data){
				return;
			}
            last = event.data;

			switch(event.data){
				case "1":
					clears();
					ppp.midroll();
					showinfo("Ad displayed from event source");
				break;
				case "2":
					clears();
					ppp.getMediaModule().pause();
                    showinfo("Player paused from event source");
				break;
				case "3":
					clears();
					ppp.getMediaModule().play();
  		            showinfo("Player started from event source");
				break;
			}
		};

}

</script>
